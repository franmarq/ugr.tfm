---
title: "TFM - Citi Bike System Analysis"
author: "franmarq@gmail.com"
date: "2024-11-09"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

#library(openxlsx)
library(tidyverse)
library(lubridate)
library(summarytools)
library(knitr)

```

configuramos el directorio local de trabajo. 

Cargamos las librerias de trabajo e Importamos la data previamente ubicada en el folder /data


```{r prepdata}
setwd('C:/Users/franm/OneDrive/Documents/Personales/Javier/Academicos/UGR - Estadistica Aplicada/Materias/24-25/TFM')

# Leer el archivo RDS
data_citybike <- "data/citybike/datos_filtrados.rds"
data_citybike2 <- "data/citybike/datos_filtrados2.rds"

datos_rds <- readRDS(data_citybike)
datos_rds2 <- readRDS(data_citybike2)

datos_rds%>%
  glimpse()

datos_rds2%>%
  glimpse()

```

Aplicamos algunes ajustes iniciales al conjunto de forma de no tener problemas asociados a datos faltantes, incongruentes, fuera de rango   

```{r evaltrans, results='asis'}
## Generar un resumen del conjunto de datos del tren

#No datos faltantes
datos_rds<-na.omit(datos_rds)


#adjustments by imputation values
datos_rds$duracion_min[datos_rds$duracion_min < 0]<-0
datos_rds$fecha_ride[datos_rds$fecha_ride<'2022-11-01']<-'2022-11-01'
datos_rds$started_at[datos_rds$started_at<'2022-11-01']<-'2022-11-01'


# after Results
datos_rds_sum_tbl <- datos_rds %>%
dfSummary(plain.ascii = FALSE, style = "grid", graph.magnif = 0.75, method="render")


datos_rds_sum_tbl%>%
    select(-text.graph) %>%
    knitr::kable(align = "c")

```

Inicialmente tenemos 8 variables, de las cuales 




```{r readWeather}
#Lectura de datos climaticos

#setwd('C:/Users/franm/OneDrive/Documents/Personales/Javier/Academicos/UGR - Estadistica Aplicada/Materias/24-25/TFM')

#getwd()

#datos_clima<- read.csv("data/NYC weather 2022-2024 v2.csv")

datos_clima<- read.csv("C:/Users/franm/OneDrive/Documents/Personales/Javier/Academicos/UGR - Estadistica Aplicada/Materias/24-25/TFM/data/bquxjob_70425b88_19a27917339.csv")


datos_clima%>%
  glimpse()
  
```


```{r readWeatherBQ}
# Cargar el paquete cada vez que inicies R
library(bigrquery)


# Autenticar tu sesión
bq_auth()


# 1. ---- Define el ID de tu proyecto en GCP ----
project_id <- "api-public-data-access"

# 2. ---- Define la consulta SQL ----
sql_query <- "
SELECT *
FROM `bigquery-public-data.noaa_gsod.gsod20*`
WHERE stn = '725053'
  -- 1. Limita las tablas a escanear solo a los años relevantes
  AND _TABLE_SUFFIX BETWEEN '22' AND '25'
  -- 2. Crea una fecha y filtra por el rango exacto
  AND PARSE_DATE('%Y%m%d', CONCAT(year, mo, da)) BETWEEN '2022-10-01' AND '2025-09-30'
ORDER BY year, mo, da
limit 10000
"

# 3. ---- Ejecuta la consulta ----
bq_job <- bq_project_query(project_id, sql_query)


# 4. ---- Descarga los resultados a un data frame de R ----
datos_clima_nyc <- bq_table_download(bq_job)


datos_clima_nyc%>%
  glimpse()
  
```


```{r proc_datos_clima_nyc}
datos_clima_nyc2 <- datos_clima_nyc %>%
  select(date,temp, visib,wdsp,max,min,prcp,fog,rain_drizzle,snow_ice_pellets,hail,thunder,tornado_funnel_cloud)
 

```